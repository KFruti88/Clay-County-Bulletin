<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Clay County Bulletin</title>
    <style>
        .clay-county-news-box { 
            width: 100% !important; 
            max-width: 100% !important; 
            margin: 0 !important; 
            padding: 0 !important;
            border: none !important; 
            background-color: #fcf6de; 
            font-family: Arial, sans-serif; 
            overflow: visible !important;
            display: block !important;
        }
        
        .calendar-header { 
            text-align: center; 
            border-top: 4px solid #222; 
            border-bottom: 2px solid #222; 
            padding: 10px 0; 
            margin-bottom: 20px; 
        }

        .section-label { 
            font-family: "Times New Roman", serif; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #ccc; 
            display: block; 
        }

        .safety-alert-card {
            border-left: 10px solid #eb1c24; 
            background: #fff5f5; 
            padding: 18px; 
            margin-bottom: 15px; 
            border-radius: 4px;
        }

        .event-entry { 
            display: flex; 
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 1px dashed #999; 
        }

        .event-date-box { 
            min-width: 80px; 
            text-align: center; 
            padding: 10px 5px; 
            margin-right: 20px; 
            border: 1px solid #222; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .event-day { font-size: 24px; font-weight: bold; line-height: 1; }
        .event-month { font-size: 12px; text-transform: uppercase; font-weight: bold; }

        .event-info h4 { font-family: "Times New Roman", serif; font-size: 18px; margin: 0; color: #222; font-weight: bold; }
        .event-meta { font-size: 11px; text-transform: uppercase; display: block; color: #666; font-weight: bold; margin-bottom: 5px; }

        .amazon-deal-link {
            display: block;
            text-align: center;
            background: #f0c14b;
            color: #111;
            padding: 12px;
            text-decoration: none;
            font-weight: bold;
            border-radius: 3px;
            margin: 20px 0;
            border: 1px solid #a88734;
        }

        .report-link { 
            display: block; 
            text-align: center; 
            padding: 10px; 
            border: 1px dashed #eb1c24; 
            color: #eb1c24; 
            text-decoration: none; 
            font-weight: bold; 
            font-size: 13px; 
            margin-top: 10px; 
        }

        @media (max-width: 480px) {
            .event-entry { flex-direction: column; }
            .event-date-box { margin-bottom: 10px; width: fit-content; min-width: 100px; }
        }
    </style>
</head>
<body>

<div class="clay-county-news-box">
    <div class="calendar-header">
        <h2 style="font-family: 'Times New Roman', serif; font-weight: 900; text-transform: uppercase; margin: 0; font-size: 24px;">Clay County Bulletin</h2>
    </div>

    <span class="section-label" style="color: #eb1c24; border-bottom: 2px solid #eb1c24;">Public Safety Alerts</span>
    <div id="safety-target"></div>
    <a href="https://forms.gle/MTx4rePosdFDbfgx9" target="_blank" class="report-link">‚ö†Ô∏è Report a Hazard</a>

    <a href="https://www.amazon.com/b?node=120697190011&tag=werewolf3788-20" target="_blank" class="amazon-deal-link">
        üõí View Trending Inspiration Deals
    </a>

    <span class="section-label">Upcoming Schedule</span>
    <div id="calendar-target"></div>
</div>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeffFYYrzXJ9JXdmkynl5JbkvWZJusl812_NZuX63o6DynnJwC8G3AxiZLfoh5QGyr2Kys2mVioN7/pub?gid=670653122&single=true&output=csv";
    const ICS_URL = "https://calendar.google.com/calendar/ical/ceab82d01e29c237da2e761555f2d2c2da76431b94e0def035ff04410e2cd71d%40group.calendar.google.com/public/basic.ics";

    const townColors = {
        "Flora": { bg: "#0c0b82", text: "#fe4f00" },
        "Louisville": { bg: "#010101", text: "#eb1c24" },
        "Clay City": { bg: "#8a8a88", text: "#0c30f0" },
        "Xenia": { bg: "#000000", text: "#fdb813" },
        "Sailor Springs": { bg: "#000000", text: "#a020f0" },
        "Clay County": { bg: "#333333", text: "#ffffff" }
    };

    // Safe CSV Parser to handle commas inside fields
    function parseCSVLine(line) {
        const result = [];
        let cur = '';
        let inQuotes = false;
        for (let char of line) {
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) {
                result.push(cur.trim());
                cur = '';
            } else cur += char;
        }
        result.push(cur.trim());
        return result;
    }

    async function loadSafety() {
        try {
            const res = await fetch(SHEET_URL);
            const text = await res.text();
            const lines = text.split(/\r?\n/).slice(1);
            let html = "";
            const now = new Date().getTime();
            const oneDay = 24 * 60 * 60 * 1000;

            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if (cols.length >= 2 && cols[0]) {
                    const timestamp = new Date(cols[0]);
                    if ((now - timestamp.getTime()) < oneDay) {
                        const hazard = cols[1] || "Safety Alert";
                        const town = cols[2] || "Clay County";
                        html += `<div class="safety-alert-card">
                            <h3 style="margin:0; color:#eb1c24;">‚ö†Ô∏è ${hazard.toUpperCase()}</h3>
                            <div style="font-weight:bold; margin:5px 0;">Town: ${town}</div>
                            <div style="font-size:11px; color:#666;">Reported: ${timestamp.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        </div>`;
                    }
                }
            });
            document.getElementById('safety-target').innerHTML = html || "<p style='font-size:12px; color:#999;'>No active alerts for the last 24 hours.</p>";
        } catch (e) { console.error(e); }
    }

    async function loadCalendar() {
        try {
            const proxy = "https://api.allorigins.win/raw?url=";
            const res = await fetch(proxy + encodeURIComponent(ICS_URL));
            const data = await res.text();
            
            const events = [];
            const lines = data.split(/\r?\n/);
            let cur = null;
            
            lines.forEach(l => {
                if(l.startsWith("BEGIN:VEVENT")) cur = {};
                else if(l.startsWith("END:VEVENT")) { if(cur && cur.start) events.push(cur); cur = null; }
                else if(cur) {
                    if(l.startsWith("SUMMARY:")) cur.summary = l.substring(8).trim();
                    if(l.startsWith("LOCATION:")) cur.location = l.substring(9).trim();
                    if(l.startsWith("DTSTART")) {
                        const dStr = l.split(":")[1];
                        if(dStr) cur.start = new Date(dStr.substring(0,4), dStr.substring(4,6)-1, dStr.substring(6,8));
                    }
                }
            });

            const upcoming = events
                .filter(ev => ev.start >= new Date().setHours(0,0,0,0))
                .sort((a, b) => a.start - b.start)
                .slice(0, 5);

            let html = "";
            upcoming.forEach(ev => {
                const date = new Date(ev.start);
                const search = (ev.summary + " " + (ev.location || "")).toLowerCase();
                let theme = townColors["Clay County"];

                for (const t in townColors) {
                    if (search.includes(t.toLowerCase())) { theme = townColors[t]; break; }
                }

                html += `<div class="event-entry">
                    <div class="event-date-box" style="background-color:${theme.bg}; color:${theme.text};">
                        <span class="event-month">${date.toLocaleString('en-US', {month:'short'})}</span>
                        <span class="event-day">${date.getDate()}</span>
                    </div>
                    <div class="event-info">
                        <span class="event-meta">${ev.location || "Clay County"}</span>
                        <h4>${ev.summary}</h4>
                    </div>
                </div>`;
            });
            document.getElementById('calendar-target').innerHTML = html || "No upcoming events.";
        } catch (e) { console.error(e); }
    }

    loadSafety();
    loadCalendar();

    function sendHeight() {
        const h = document.body.scrollHeight;
        window.parent.postMessage({ 'height': h }, "*");
    }
    window.onload = sendHeight;
    window.onresize = sendHeight;
</script>
</body>
</html>
