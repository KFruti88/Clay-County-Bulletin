<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Clay County Bulletin</title>
    <style>
        /* Base Container - 90% Width as per standards */
        .clay-county-news-box { 
            width: 90%; 
            max-width: 500px; 
            margin: 20px auto; 
            padding: 25px; 
            border: 1px solid #222; 
            background-color: #fffdf5; 
            box-shadow: 6px 6px 0px #222; 
            font-family: Arial, sans-serif; 
        }
        
        .calendar-header { 
            text-align: center; 
            border-top: 4px solid #222; 
            border-bottom: 2px solid #222; 
            padding: 10px 0; 
            margin-bottom: 20px; 
        }

        .section-label { 
            font-family: "Times New Roman", serif; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #ccc; 
            display: block; 
        }

        /* Safety Alert Card */
        .safety-alert-card {
            border-left: 10px solid #eb1c24; 
            background: #fff5f5; 
            padding: 18px; 
            margin-bottom: 15px; 
            border-radius: 4px;
        }

        /* Calendar Entry Styling */
        .event-entry { 
            display: flex; 
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 1px dashed #999; 
        }

        .event-date-box { 
            min-width: 70px; 
            text-align: center; 
            padding: 10px 5px; 
            margin-right: 20px; 
            border: 1px solid #222; 
        }

        .event-day { font-size: 22px; font-weight: bold; display: block; line-height: 1; }
        .event-month { font-size: 11px; text-transform: uppercase; font-weight: bold; }

        .event-info h4 { font-family: "Times New Roman", serif; font-size: 18px; margin: 0; color: #222; font-weight: bold; }
        .event-meta { font-size: 11px; text-transform: uppercase; display: block; color: #666; font-weight: bold; margin-bottom: 5px; }

        /* Color Lock Themes */
        .theme-flora { background-color: #fe4f00 !important; color: #0c0b82 !important; }
        .theme-louisville { background-color: #eb1c24 !important; color: #010101 !important; }
        .theme-clay-city { background-color: #8a8a88 !important; color: #0c30f0 !important; }
        .theme-default { background-color: #333333 !important; color: #ffffff !important; }

        .amazon-deal-link {
            display: block;
            text-align: center;
            background: #f0c14b;
            color: #111;
            padding: 10px;
            text-decoration: none;
            font-weight: bold;
            border-radius: 3px;
            margin: 20px 0;
            border: 1px solid #a88734;
        }

        @media (max-width: 480px) {
            .event-entry { flex-direction: column; }
            .event-date-box { margin-bottom: 10px; width: fit-content; }
        }
    </style>
</head>
<body>

<div class="clay-county-news-box">
    <div class="calendar-header">
        <h2 style="font-family: 'Times New Roman', serif; font-weight: 900; text-transform: uppercase; margin: 0; font-size: 24px;">Clay County Bulletin</h2>
    </div>

    <span class="section-label" style="color: #eb1c24; border-bottom: 2px solid #eb1c24;">Public Safety Alerts</span>
    <div id="safety-target"></div>

    <a href="https://www.amazon.com/b?node=120697190011&tag=werewolf3788-20" target="_blank" class="amazon-deal-link">
        üõí View Today's Trending Inspiration Deals
    </a>

    <span class="section-label">Upcoming Schedule</span>
    <div id="calendar-target"></div>
</div>

<script>
    const SAFETY_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaeffFYYrzXJ9JXdmkynl5JbkvWZJusl812_NZuX63o6DynnJwC8G3AxiZLfoh5QGyr2Kys2mVioN7/pub?gid=670653122&single=true&output=csv";
    const CALENDAR_ICS_URL = "https://calendar.google.com/calendar/ical/ceab82d01e29c237da2e761555f2d2c2da76431b94e0def035ff04410e2cd71d%40group.calendar.google.com/public/basic.ics";

    async function loadSafetyAlerts() {
        try {
            const response = await fetch(SAFETY_SHEET_URL);
            const csv = await response.text();
            const rows = csv.split('\n').slice(1);
            let html = "";
            const cutoff = new Date().getTime() - (24 * 60 * 60 * 1000);

            rows.forEach(row => {
                const cols = row.split(',');
                if (cols.length > 1) {
                    const time = new Date(cols[0]).getTime();
                    if (time > cutoff) {
                        html += `<div class="safety-alert-card">
                            <h3 style="margin:0; color:#eb1c24;">‚ö†Ô∏è ${cols[1].toUpperCase()}</h3>
                            <div style="font-weight:bold; margin:5px 0;">üìç ${cols[3]}</div>
                            <div style="font-size:11px; color:#666;">Reported: ${new Date(cols[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>`;
                    }
                }
            });
            document.getElementById('safety-target').innerHTML = html || "<p style='font-size:12px; color:#999;'>No active alerts.</p>";
        } catch (e) { console.log(e); }
    }

    async function loadCalendar() {
        try {
            const proxy = "https://api.allorigins.win/raw?url=";
            const response = await fetch(proxy + encodeURIComponent(CALENDAR_ICS_URL));
            const data = await response.text();
            const events = parseICS(data);
            
            // FILTER: Future events only | SORT: Soonest first | SLICE: Top 5 only
            const displayEvents = events
                .filter(e => e.start >= new Date().setHours(0,0,0,0))
                .sort((a, b) => a.start - b.start)
                .slice(0, 5);

            let html = "";
            displayEvents.forEach(ev => {
                const date = new Date(ev.start);
                const summary = ev.summary.toLowerCase();
                const townClass = summary.includes("flora") ? "theme-flora" : 
                                  summary.includes("louisville") ? "theme-louisville" : 
                                  summary.includes("clay city") ? "theme-clay-city" : "theme-default";

                html += `<div class="event-entry">
                    <div class="event-date-box ${townClass}">
                        <span class="event-month">${date.toLocaleString('en-US', {month:'short'})}</span>
                        <span class="event-day">${date.getDate()}</span>
                    </div>
                    <div class="event-info">
                        <span class="event-meta">${ev.location || "Clay County"}</span>
                        <h4>${ev.summary}</h4>
                    </div>
                </div>`;
            });
            document.getElementById('calendar-target').innerHTML = html || "No upcoming events.";
        } catch (e) { console.log(e); }
    }

    function parseICS(data) {
        const events = [];
        const lines = data.split(/\r?\n/);
        let cur = null;
        lines.forEach(l => {
            if(l.startsWith("BEGIN:VEVENT")) cur = {};
            else if(l.startsWith("END:VEVENT")) { events.push(cur); cur = null; }
            else if(cur) {
                if(l.startsWith("SUMMARY:")) cur.summary = l.substring(8);
                if(l.startsWith("LOCATION:")) cur.location = l.substring(9);
                if(l.startsWith("DTSTART")) {
                    const d = l.split(":")[1];
                    cur.start = new Date(d.substring(0,4), d.substring(4,6)-1, d.substring(6,8));
                }
            }
        });
        return events;
    }

    loadSafetyAlerts();
    loadCalendar();
</script>

</body>
</html>
